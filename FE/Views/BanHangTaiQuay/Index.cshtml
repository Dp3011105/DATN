@{
    ViewData["Title"] = "Bán hàng tại quầy";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
    .pos-wrap { display:grid; grid-template-columns: 1fr 420px; gap:1rem; }
    .product-card { border:1px solid #eee; border-radius:10px; padding:.5rem; cursor:pointer; transition:.2s; }
    .product-card:hover { box-shadow: 0 2px 10px rgba(0,0,0,.08); }
    .product-img { width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:8px; background:#f7f7f7; }
    .cart-item { border-bottom:1px dashed #e5e5e5; padding:.5rem 0; }
    .chip { display:inline-block; border:1px solid #ddd; border-radius:999px; padding:.1rem .5rem; margin-right:.25rem; font-size:.8rem; }
    .money { font-weight:600; }
</style>

<div class="container-fluid py-3">
    <h3 class="mb-3">Bán hàng tại quầy</h3>

    <div class="pos-wrap">
        <!-- LEFT: danh sách sản phẩm -->
        <div>
            <div class="d-flex gap-2 mb-2">
                <input id="txtSearch" class="form-control" style="max-width:360px" placeholder="Tìm sản phẩm... (tên/mã)">
                <button class="btn btn-secondary" onclick="searchProducts(1)">Tìm</button>
                <button class="btn btn-outline-secondary" onclick="resetSearch()">Xoá</button>
            </div>
            <div id="gridProducts" class="row g-2"></div>
            <div class="mt-2 d-flex align-items-center gap-2">
                <button id="btnPrev" class="btn btn-sm btn-outline-primary" onclick="prevPage()">«</button>
                <span id="lblPage" class="small text-muted"></span>
                <button id="btnNext" class="btn btn-sm btn-outline-primary" onclick="nextPage()">»</button>
            </div>
        </div>

        <!-- RIGHT: giỏ hàng -->
        <div>
            <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Giỏ hàng</h5>
                    <button class="btn btn-sm btn-outline-danger" onclick="clearCart()">Xoá giỏ</button>
                </div>
                <div id="cartList" class="mt-2"></div>

                <div class="mt-2">
                    <div class="mb-2">
                        <label class="form-label mb-1">Mã voucher</label>
                        <div class="d-flex gap-2">
                            <input id="txtVoucher" class="form-control" placeholder="Nhập mã voucher">
                            <button class="btn btn-outline-primary" onclick="applyVoucher()">Áp dụng</button>
                        </div>
                        <small id="voucherMsg" class="text-muted"></small>
                    </div>

                    <div class="mb-2">
                        <label class="form-label mb-1">SĐT khách (tuỳ chọn)</label>
                        <input id="txtPhone" class="form-control" placeholder="VD: 09xxxxxxxx">
                    </div>

                    <div class="mb-2">
                        <label class="form-label mb-1">Hình thức thanh toán</label>
                        <select id="selPay" class="form-select">
                            <option value="TienMat">Tiền mặt</option>
                            <option value="The">Thẻ</option>
                            <option value="ChuyenKhoan">Chuyển khoản</option>
                        </select>
                    </div>

                    <div class="mb-2">
                        <label class="form-label mb-1">Ghi chú</label>
                        <textarea id="txtNote" class="form-control" rows="2" placeholder="Ghi chú đơn..."></textarea>
                    </div>

                    <div class="d-flex justify-content-between">
                        <span>Tạm tính</span>
                        <span class="money" id="lblTamTinh">0</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Giảm</span>
                        <span class="money text-danger" id="lblGiam">0</span>
                    </div>
                    <div class="d-flex justify-content-between fs-5 mt-1">
                        <strong>Thanh toán</strong>
                        <strong id="lblThanhToan">0</strong>
                    </div>

                    <button class="btn btn-success w-100 mt-3" onclick="taoHoaDon()">Tạo hoá đơn</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal cấu hình item (độ ngọt/đá/topping) -->
<div class="modal fade" id="modalItem" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="mdlTitle" class="modal-title">Tùy chọn</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="mdlIndex" />
                <div class="mb-2">
                    <label class="form-label">Độ ngọt</label>
                    <select id="mdlDoNgot" class="form-select"></select>
                </div>
                <div class="mb-2">
                    <label class="form-label">Lượng đá</label>
                    <select id="mdlLuongDa" class="form-select"></select>
                </div>
                <div class="mb-2">
                    <label class="form-label">Topping</label>
                    <div id="mdlToppings" class="d-flex flex-wrap gap-2"></div>
                </div>
                <div class="mb-2">
                    <label class="form-label">Số lượng</label>
                    <input id="mdlQty" type="number" min="1" class="form-control" />
                </div>
                <div class="text-end">
                    <div>Đơn giá: <span class="money" id="mdlDonGia">0</span></div>
                    <div>Topping: <span class="money" id="mdlTienTop">0</span></div>
                    <div>Tạm tính: <span class="money" id="mdlTamTinh">0</span></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button class="btn btn-primary" onclick="saveItemConfig()">Lưu</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let PAGE = 1, PAGE_SIZE = 12, TOTAL = 0;
    let OPTIONS = { doNgots: [], luongDas: [], toppings: [] };
    let CART = [];
    let VOUCHER = null; // { id, code, giam, msg }
    let DISCOUNT = 0;

    function fmtVND(n){ try{return (n||0).toLocaleString('vi-VN',{style:'currency',currency:'VND'})}catch{return n} }

    function resetSearch(){
      document.getElementById('txtSearch').value='';
      searchProducts(1);
    }

    async function searchProducts(page){
      PAGE = page || 1;
      const q = document.getElementById('txtSearch').value || '';
      const url = `/BanHangTaiQuay/GetSanPham?tuKhoa=${encodeURIComponent(q)}&page=${PAGE}&pageSize=${PAGE_SIZE}`;
      const rs = await fetch(url); const js = await rs.json();
      const grid = document.getElementById('gridProducts');
      grid.innerHTML = '';
      if(!js.success){ grid.innerHTML = `<div class="text-danger">Không load được sản phẩm: ${js.message||''}</div>`; return; }
      TOTAL = js.total||0;

      (js.data||[]).forEach(p=>{
        const col = document.createElement('div'); col.className='col-6 col-md-4 col-lg-3';
        col.innerHTML = `
          <div class="product-card" onclick='addToCart(${JSON.stringify(p.ID_San_Pham)},${JSON.stringify(p.Ten_San_Pham)},${JSON.stringify(p.Gia_Ban)})'>
            <img class="product-img" src="${p.Hinh||''}" onerror="this.src='https://placehold.co/400x400?text=Drink';" />
            <div class="mt-1 fw-semibold">${p.Ten_San_Pham||''}</div>
            <div class="text-muted small">${p.Ma_San_Pham||''}</div>
            <div class="money">${fmtVND(p.Gia_Ban)}</div>
          </div>`;
        grid.appendChild(col);
      });

      document.getElementById('lblPage').textContent = `Trang ${PAGE} / ${Math.max(1, Math.ceil(TOTAL/PAGE_SIZE))}`;
    }
    function prevPage(){ if(PAGE>1){ searchProducts(PAGE-1) } }
    function nextPage(){ if(PAGE<Math.ceil(TOTAL/PAGE_SIZE)){ searchProducts(PAGE+1) } }

    async function loadOptions(){
      const rs = await fetch('/BanHangTaiQuay/GetOptions'); const js = await rs.json();
      if(js.success){
        OPTIONS.doNgots = js.doNgots||[];
        OPTIONS.luongDas = js.luongDas||[];
        OPTIONS.toppings = js.toppings||[];
      }
    }

    function addToCart(id, name, price){
      CART.push({
        sanPhamId:id, ten:name, donGia:price, soLuong:1,
        doNgotId:null, luongDaId:null, toppingIds:[], tienTopping:0
      });
      renderCart();
    }

    function removeItem(idx){ CART.splice(idx,1); renderCart(); }
    function openConfig(idx){
      const it = CART[idx];
      document.getElementById('mdlIndex').value = idx;
      document.getElementById('mdlTitle').textContent = it.ten;

      const selSweet = document.getElementById('mdlDoNgot');
      selSweet.innerHTML = OPTIONS.doNgots.map(d=>`<option value="${d.ID_DoNgot}" ${it.doNgotId==d.ID_DoNgot?'selected':''}>${d.Muc_Do}</option>`).join('');

      const selIce = document.getElementById('mdlLuongDa');
      selIce.innerHTML = OPTIONS.luongDas.map(d=>`<option value="${d.ID_LuongDa}" ${it.luongDaId==d.ID_LuongDa?'selected':''}>${d.Muc_Da}</option>`).join('');

      const topWrap = document.getElementById('mdlToppings');
      topWrap.innerHTML = '';
      OPTIONS.toppings.forEach(t=>{
        const ck = document.createElement('div');
        ck.innerHTML = `
          <label class="chip">
            <input type="checkbox" class="form-check-input me-1" value="${t.ID_Topping}" data-price="${t.Gia_Topping}" ${it.toppingIds.includes(t.ID_Topping)?'checked':''}>
            ${t.Ten_Topping} (+${fmtVND(t.Gia_Topping)})
          </label>`;
        topWrap.appendChild(ck);
      });

      document.getElementById('mdlQty').value = it.soLuong;
      calcModalMoney();
      new bootstrap.Modal(document.getElementById('modalItem')).show();
    }
    function calcModalMoney(){
      const idx = +document.getElementById('mdlIndex').value;
      const it = CART[idx];
      const qty = +document.getElementById('mdlQty').value || 1;
      let top = 0;
      document.querySelectorAll('#mdlToppings input[type="checkbox"]').forEach(ch=>{
        if(ch.checked){ top += parseFloat(ch.getAttribute('data-price') || '0'); }
      });
      document.getElementById('mdlDonGia').textContent = fmtVND(it.donGia);
      document.getElementById('mdlTienTop').textContent = fmtVND(top);
      document.getElementById('mdlTamTinh').textContent = fmtVND((it.donGia + top) * qty);
    }
    document.addEventListener('change', e=>{
      if(e.target.closest('#mdlToppings') || e.target.id==='mdlQty'){ calcModalMoney(); }
    });

    function saveItemConfig(){
      const idx = +document.getElementById('mdlIndex').value;
      const it = CART[idx];

      it.doNgotId = parseInt(document.getElementById('mdlDoNgot').value)||null;
      it.luongDaId = parseInt(document.getElementById('mdlLuongDa').value)||null;

      const topIds = [];
      let topMoney = 0;
      document.querySelectorAll('#mdlToppings input[type="checkbox"]').forEach(ch=>{
        if(ch.checked){
          topIds.push(parseInt(ch.value));
          topMoney += parseFloat(ch.getAttribute('data-price')||'0');
        }
      });
      it.toppingIds = topIds;
      it.tienTopping = topMoney;

      it.soLuong = parseInt(document.getElementById('mdlQty').value)||1;

      bootstrap.Modal.getInstance(document.getElementById('modalItem')).hide();
      renderCart();
    }

    function renderCart(){
      const wrap = document.getElementById('cartList');
      wrap.innerHTML = '';
      if(CART.length===0){ wrap.innerHTML='<div class="text-muted">Chưa có sản phẩm</div>'; }
      CART.forEach((it,idx)=>{
        const optChips = `
          ${it.doNgotId?`<span class='chip'>Ngọt: ${findName(OPTIONS.doNgots,'ID_DoNgot','Muc_Do',it.doNgotId)}</span>`:''}
          ${it.luongDaId?`<span class='chip'>Đá: ${findName(OPTIONS.luongDas,'ID_LuongDa','Muc_Da',it.luongDaId)}</span>`:''}
          ${(it.toppingIds||[]).length>0?`<span class='chip'>${(it.toppingIds||[]).length} topping</span>`:''}
        `;
        const line = document.createElement('div');
        line.className = 'cart-item';

        line.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-semibold">${it.ten}</div>
              <div class="text-muted small">${optChips}</div>
              <div class="text-muted small">Đơn giá: ${fmtVND(it.donGia)} + topping ${fmtVND(it.tienTopping)}</div>
            </div>
            <div class="text-end">
              <div class="input-group input-group-sm">
                <button class="btn btn-outline-secondary" onclick="decQty(${idx})">-</button>
                <input class="form-control text-center" style="width:60px" value="${it.soLuong}" onblur="setQty(${idx}, this.value)">
                <button class="btn btn-outline-secondary" onclick="incQty(${idx})">+</button>
              </div>
              <div class="money mt-1">${fmtVND((it.donGia + it.tienTopping) * it.soLuong)}</div>
              <div class="mt-2 d-flex gap-1 justify-content-end">
                <button class="btn btn-sm btn-outline-primary" onclick="openConfig(${idx})">Tùy chọn</button>
                <button class="btn btn-sm btn-outline-danger" onclick="removeItem(${idx})">Xoá</button>
              </div>
            </div>
          </div>`;
        wrap.appendChild(line);
      });
      recalcTotals();
    }

    function findName(arr, idKey, nameKey, id){
      const o = (arr||[]).find(x=>x[idKey]==id);
      return o? o[nameKey] : '';
    }

    function decQty(i){ if(CART[i].soLuong>1){ CART[i].soLuong--; renderCart(); } }
    function incQty(i){ CART[i].soLuong++; renderCart(); }
    function setQty(i,val){ let v=parseInt(val)||1; if(v<1)v=1; CART[i].soLuong=v; renderCart(); }

    function recalcTotals(){
      const tam = CART.reduce((s,it)=> s + (it.donGia + it.tienTopping)*it.soLuong, 0);
      // DISCOUNT giới hạn 50%
      let giam = Math.min(DISCOUNT, tam * 0.5);
      document.getElementById('lblTamTinh').textContent = fmtVND(tam);
      document.getElementById('lblGiam').textContent = `- ${fmtVND(giam)}`;
      document.getElementById('lblThanhToan').textContent = fmtVND(Math.max(0, tam - giam));
    }

    async function applyVoucher(){
      const code = (document.getElementById('txtVoucher').value||'').trim();
      const tam = CART.reduce((s,it)=> s + (it.donGia + it.tienTopping)*it.soLuong, 0);
      const msg = document.getElementById('voucherMsg');

      if(!code){ VOUCHER=null; DISCOUNT=0; msg.textContent=''; recalcTotals(); return; }

      const url = `/BanHangTaiQuay/KiemTraVoucher?ma=${encodeURIComponent(code)}&tongTien=${tam}`;
      const rs = await fetch(url); const js = await rs.json();
      if(js.success){
        VOUCHER = { id: js.voucher?.id || js.voucher?.ID_Voucher, code: code };
        DISCOUNT = js.giam || 0;
        msg.textContent = `Áp dụng thành công. Giảm ${fmtVND(DISCOUNT)}.`;
      } else {
        VOUCHER=null; DISCOUNT=0;
        msg.textContent = js.message || 'Voucher không hợp lệ.';
      }
      recalcTotals();
    }

    function clearCart(){ CART=[]; VOUCHER=null; DISCOUNT=0; document.getElementById('txtVoucher').value=''; document.getElementById('voucherMsg').textContent=''; renderCart(); }

    async function taoHoaDon(){
      if(CART.length===0){ alert('Giỏ hàng trống.'); return; }
      const tam = CART.reduce((s,it)=> s + (it.donGia + it.tienTopping)*it.soLuong, 0);
      const giam = Math.min(DISCOUNT, tam*0.5);
      const payload = {
        HinhThucThanhToan: document.getElementById('selPay').value,
        KhachHang_SDT: (document.getElementById('txtPhone').value||'').trim() || null,
        GhiChu: (document.getElementById('txtNote').value||'').trim() || null,
        VoucherId: VOUCHER?.id || null,
        TongTien: tam,
        TienGiam: giam,
        Items: CART.map(it=>({
          SanPhamId: it.sanPhamId,
          SoLuong: it.soLuong,
          DonGia: it.donGia,
          DoNgotId: it.doNgotId,
          LuongDaId: it.luongDaId,
          ToppingIds: it.toppingIds
        }))
      };

      const rs = await fetch('/BanHangTaiQuay/TaoHoaDonTaiQuay', {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
      });
      const js = await rs.json();
      if(js.success){
        alert('Tạo hoá đơn thành công!');
        clearCart();
        // Điều hướng sang chi tiết đơn nếu muốn:
        // if(js.data?.id) window.location.href = `/QuanLyDonHang/ChiTiet/${js.data.id}`;
      } else {
        alert(js.message || 'Tạo hoá đơn thất bại.');
      }
    }

    window.addEventListener('DOMContentLoaded', async ()=>{
      await loadOptions();
      await searchProducts(1);
      renderCart();
    });
</script>
