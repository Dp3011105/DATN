@* @model BE.models.TaiKhoan
@{
    ViewData["Title"] = "Sửa tài khoản";
    Layout = "_AdminLayout";

    var nhanViens = ViewBag.NhanViens as IEnumerable<BE.models.NhanVien>;
    var searchNhanVien = ViewBag.SearchNhanVien as string ?? "";
}

<style>

    .btn-gradient {
        background: linear-gradient(45deg, #4facfe, #00f2fe);
        color: white;
        border: none;
        transition: all 0.3s ease-in-out;
        box-shadow: 0 4px 10px rgba(0, 150, 255, 0.3);
    }

        .btn-gradient:hover {
            background: linear-gradient(45deg, #00f2fe, #4facfe);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 150, 255, 0.5);
        }

        .btn-gradient:active {
            transform: scale(0.95);
            box-shadow: 0 3px 6px rgba(0, 150, 255, 0.4);
        }

    .btn-secondary {
        transition: all 0.3s ease;
    }

        .btn-secondary:hover {
            background-color: #6c757d;
            color: #fff;
            transform: translateY(-2px);
        }

    .card {
        border-radius: 20px;
        background: #ffffff;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }

    .table-nhanvien {
        margin-top: 20px;
    }

        .table-nhanvien tr:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }

    .btn-select {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
        border: none;
        transition: all 0.3s ease;
    }

        .btn-select:hover {
            background: linear-gradient(45deg, #20c997, #28a745);
            transform: translateY(-2px);
        }

    .search-form-nhanvien {
        margin-bottom: 20px;
    }

        .search-form-nhanvien input {
            border-radius: 5px;
            transition: border-color 0.3s ease;
        }

            .search-form-nhanvien input:focus {
                border-color: #00f2fe;
                box-shadow: 0 0 0 0.2rem rgba(0, 150, 255, 0.25);
            }

        .search-form-nhanvien .btn-search {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border: none;
        }

            .search-form-nhanvien .btn-search:hover {
                background: linear-gradient(45deg, #0056b3, #004085);
                transform: translateY(-2px);
            }

    .form-control:focus {
        border-color: #00f2fe;
        box-shadow: 0 0 0 0.2rem rgba(0, 150, 255, 0.25);
    }
</style>

<div class="row">
    <div class="col-md-6">
        <div class="card shadow border-0 p-4">
            <h4 class="mb-4"><i class="fas fa-edit me-2 text-primary"></i> Sửa tài khoản</h4>

            @if (ViewBag.Error != null)
            {
                <div class="alert alert-danger">@ViewBag.Error</div>
            }

            <form asp-action="Edit" method="post">
                <div asp-validation-summary="All" class="text-danger mb-3"></div>

                <input type="hidden" asp-for="ID_Tai_Khoan" />
                <input type="hidden" asp-for="ID_Nhan_Vien" id="selectedNhanVienId" />

                <div class="mb-3">
                    <label asp-for="Ten_Nguoi_Dung" class="form-label fw-semibold"><i class="fas fa-user me-2 text-primary"></i>Tên người dùng</label>
                    <input asp-for="Ten_Nguoi_Dung" id="tenNguoiDung" class="form-control" />
                    <span asp-validation-for="Ten_Nguoi_Dung" class="text-danger"></span>
                </div>
                <div class="mb-3">
                    <label asp-for="Email" class="form-label fw-semibold"><i class="fas fa-envelope me-2 text-primary"></i>Email</label>
                    <input asp-for="Email" id="email" class="form-control" />
                    <span asp-validation-for="Email" class="text-danger"></span>
                </div>
                <div class="mb-3">
                    <label asp-for="Mat_Khau" class="form-label fw-semibold"><i class="fas fa-lock me-2 text-primary"></i>Mật khẩu (để trống nếu không thay đổi)</label>
                    <input asp-for="Mat_Khau" class="form-control" type="password" />
                    <span asp-validation-for="Mat_Khau" class="text-danger"></span>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <a asp-action="Index" class="btn btn-secondary rounded-pill">
                        <i class="fas fa-arrow-left me-1"></i> Quay lại
                    </a>
                    <button type="submit" class="btn btn-gradient rounded-pill px-4">
                        <i class="fas fa-save me-1"></i> Cập nhật
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card shadow border-0 p-4">
            <h4 class="mb-4"><i class="fas fa-users me-2 text-primary"></i> Danh sách nhân viên chưa có tài khoản</h4>

            <form asp-action="Edit" method="get" class="row g-2 search-form-nhanvien">
                <input type="hidden" name="id" value="@Model.ID_Tai_Khoan" />
                <div class="col-md-8">
                    <input type="text" name="searchNhanVien" class="form-control"
                           placeholder="Tìm kiếm theo tên hoặc email..."
                           value="@searchNhanVien" />
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-search w-100"><i class="fas fa-search me-1"></i> Tìm</button>
                </div>
            </form>

            @if (nhanViens != null && nhanViens.Any())
            {
                <div class="table-responsive table-nhanvien">
                    <table class="table table-hover align-middle">
                        <thead class="table-primary">
                            <tr>
                                <th>#</th>
                                <th>Tên nhân viên</th>
                                <th>Email</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int stt = 1;
                            }
                            @foreach (var nv in nhanViens)
                            {
                                <tr>
                                    <td>@stt</td>
                                    <td>@nv.Ho_Ten</td>
                                    <td>@nv.Email</td>
                                    <td>
                                        <button class="btn btn-select btn-sm" onclick="selectNhanVien(@nv.ID_Nhan_Vien, '@nv.Ho_Ten', '@nv.Email')">
                                            <i class="fas fa-check me-1"></i> Chọn
                                        </button>
                                    </td>
                                </tr>
                                stt++;
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <p class="text-muted">Không có nhân viên nào chưa có tài khoản hoặc không tìm thấy kết quả.</p>
            }
        </div>
    </div>
</div>

<script>
    function selectNhanVien(id, ten, email) {
        document.getElementById('selectedNhanVienId').value = id;
        document.getElementById('tenNguoiDung').value = ten;
        document.getElementById('email').value = email;
    }
</script> *@



@model BE.models.TaiKhoan
@{
    ViewData["Title"] = "Sửa tài khoản";
    Layout = "_AdminLayout";

    var nhanViens = ViewBag.NhanViens as IEnumerable<BE.models.NhanVien>;
    var searchNhanVien = ViewBag.SearchNhanVien as string ?? "";
    var soNhanVienChuaCoTK = ViewBag.SoNhanVienChuaCoTK as int? ?? 0;
    var soNhanVienDaCoTK = ViewBag.SoNhanVienDaCoTK as int? ?? 0;
}

<style>
    .card-custom {
        background: #fff;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }

        .card-custom:hover {
            transform: translateY(-3px);
        }

    .card-title-custom {
        font-size: 1.2rem;
        font-weight: 700;
        color: #007bff;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-gradient {
        background: linear-gradient(45deg, #4facfe, #00f2fe);
        color: white !important;
        border: none;
        border-radius: 30px;
        padding: 8px 20px;
        font-weight: 600;
        transition: all 0.3s ease-in-out;
        box-shadow: 0 4px 10px rgba(0, 150, 255, 0.3);
    }

        .btn-gradient:hover {
            background: linear-gradient(45deg, #00f2fe, #4facfe);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 150, 255, 0.5);
        }

        .btn-gradient:active {
            transform: scale(0.95);
            box-shadow: 0 3px 6px rgba(0, 150, 255, 0.4);
        }

    .btn-secondary {
        transition: all 0.3s ease;
    }

        .btn-secondary:hover {
            background-color: #6c757d;
            color: #fff;
            transform: translateY(-2px);
        }

    .form-control {
        border-radius: 8px;
        padding: 10px;
        border: 1px solid #dee2e6;
        transition: all 0.3s ease;
    }

        .form-control:focus {
            border-color: #00f2fe;
            box-shadow: 0 0 0 0.2rem rgba(0, 150, 255, 0.25);
        }

    .search-form {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }

        .search-form input {
            flex: 1;
            border-radius: 8px;
        }

    .btn-search {
        background: linear-gradient(45deg, #007bff, #0056b3);
        color: #fff;
        border-radius: 8px;
        padding: 8px 18px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

        .btn-search:hover {
            background: linear-gradient(45deg, #0056b3, #004085);
            transform: translateY(-2px);
        }

    .table-nhanvien th {
        background: linear-gradient(135deg, #007bff, #00c6ff);
        color: #fff;
        text-align: center;
    }

    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
    }

    .btn-select {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
        border: none;
        border-radius: 20px;
        padding: 6px 14px;
        font-size: 0.85rem;
        transition: all 0.3s ease;
    }

        .btn-select:hover {
            background: linear-gradient(45deg, #20c997, #28a745);
            transform: translateY(-2px);
        }

    .statistics-box {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
    }

    .stat-card {
        flex: 1;
        background: #fff;
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-card i {
            font-size: 1.6rem;
            color: #007bff;
            margin-bottom: 8px;
        }

        .stat-card span {
            font-size: 1.4rem;
            font-weight: 700;
            color: #007bff;
        }
</style>

<div class="container">
    <div class="row g-4">
        <!-- Form sửa tài khoản -->
        <div class="col-lg-6">
            <div class="card-custom">
                <h4 class="card-title-custom"><i class="fas fa-edit"></i> Sửa tài khoản</h4>

                @if (ViewBag.Error != null)
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        @ViewBag.Error
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                }

                <form asp-action="Edit" method="post">
                    <div asp-validation-summary="All" class="text-danger mb-3"></div>

                    <input type="hidden" asp-for="ID_Tai_Khoan" />
                    <input type="hidden" asp-for="ID_Nhan_Vien" id="selectedNhanVienId" />
                    <input type="hidden" asp-for="Email" id="email" />

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-id-card me-2 text-primary"></i>Tên nhân viên
                        </label>
                        <input type="text" id="tenNhanVienDisplay" class="form-control"
                               value="@(Model.NhanVien?.Ho_Ten ?? "")" disabled />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-envelope me-2 text-primary"></i>Email
                        </label>
                        <input type="text" id="emailDisplay" class="form-control"
                               value="@Model.Email" disabled />
                    </div>

                    <div class="mb-3">
                        <label asp-for="Ten_Nguoi_Dung" class="form-label">
                            <i class="fas fa-user me-2 text-primary"></i>Tên đăng nhập
                        </label>
                        <input asp-for="Ten_Nguoi_Dung" id="tenNguoiDung" class="form-control"
                               value="@Model.Ten_Nguoi_Dung" />
                        <span asp-validation-for="Ten_Nguoi_Dung" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Mat_Khau" class="form-label">
                            <i class="fas fa-lock me-2 text-primary"></i>Mật khẩu (để trống nếu không thay đổi)
                        </label>
                        <input asp-for="Mat_Khau" class="form-control" type="password" />
                        <span asp-validation-for="Mat_Khau" class="text-danger"></span>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a asp-action="Index" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i> Quay lại
                        </a>
                        <button type="submit" class="btn btn-gradient">
                            <i class="fas fa-save me-1"></i> Cập nhật
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Danh sách nhân viên -->
        <div class="col-lg-6">
            <div class="card-custom">
                <h4 class="card-title-custom"><i class="fas fa-users"></i> Nhân viên đã có tài khoản</h4>

                <div class="statistics-box">
                    <div class="stat-card">
                        <i class="fas fa-user-check"></i>
                        <h6>Đã có tài khoản</h6>
                        <span>@soNhanVienDaCoTK</span>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-user-times"></i>
                        <h6>Chưa có tài khoản</h6>
                        <span>@soNhanVienChuaCoTK</span>
                    </div>
                </div>

                <form asp-action="Edit" method="get" class="search-form">
                    <input type="hidden" name="id" value="@Model.ID_Tai_Khoan" />
                    <input type="text" name="searchNhanVien" class="form-control"
                           placeholder="Tìm kiếm theo tên hoặc email..." value="@searchNhanVien" />
                    <button type="submit" class="btn btn-search">
                        <i class="fas fa-search me-1"></i> Tìm
                    </button>
                </form>

                @if (nhanViens != null && nhanViens.Any())
                {
                    <div class="table-responsive table-nhanvien">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Tên nhân viên</th>
                                    <th>Email</th>
                                    <th class="text-center">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    int stt = 1;
                                }
                                @foreach (var nv in nhanViens)
                                {
                                    <tr>
                                        <td class="text-center">@stt</td>
                                        <td>@nv.Ho_Ten</td>
                                        <td>@nv.Email</td>
                                        <td class="text-center">
                                            <button type="button" class="btn btn-select"
                                                    onclick="selectNhanVien(@nv.ID_Nhan_Vien, '@nv.Ho_Ten', '@nv.Email')">
                                                <i class="fas fa-check me-1"></i> Chọn
                                            </button>
                                        </td>
                                    </tr>
                                    stt++;
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <p class="text-muted text-center mt-3">
                        Không có nhân viên nào đã có tài khoản hoặc không tìm thấy kết quả.
                    </p>
                }
            </div>
        </div>
    </div>
</div>

<script>
    function selectNhanVien(id, ten, email) {
        document.getElementById('selectedNhanVienId').value = id;
        document.getElementById('tenNhanVienDisplay').value = ten;   // Hiển thị tên nhân viên
        document.getElementById('email').value = email;             // Input hidden để submit
        document.getElementById('emailDisplay').value = email;      // Hiển thị email
        // Không cập nhật Ten_Nguoi_Dung khi chọn nhân viên, giữ nguyên giá trị từ model
    }

    // Khi trang tải, điền thông tin ban đầu từ model
    document.addEventListener('DOMContentLoaded', function() {
        const nhanVien = @Html.Raw(Json.Serialize(Model.NhanVien));
        if (nhanVien) {
            selectNhanVien(nhanVien.ID_Nhan_Vien, nhanVien.Ho_Ten, Model.Email);
        }
        // Đảm bảo Ten_Nguoi_Dung giữ nguyên giá trị từ model
        document.getElementById('tenNguoiDung').value = '@Model.Ten_Nguoi_Dung';
    });
</script>

@* Validation scripts nếu bạn đang sử dụng validation client-side *@
@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}