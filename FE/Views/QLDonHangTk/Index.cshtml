
@model List<FE.Models.DonHangTK>

@{
    ViewData["Title"] = "Quản Lý Đơn Hàng";
    var statusDisplay = new Dictionary<string, string>
    {
        { "Chua_Xac_Nhan", "Chưa Xác Nhận" },
        { "Da_Xac_Nhan", "Đã Xác Nhận" },
        { "Dang_Giao_Hang", "Đang Giao Hàng" },
        { "Hoan_Thanh", "Hoàn Thành" },
        { "Huy_Don", "Hủy Đơn" }
    };
    var currentStatus = ViewBag.CurrentStatus as string;
    var idKhachHang = ViewBag.ID_Khach_Hang;
}

<div class="container mt-5">
    <h2 class="text-center mb-4 fw-bold text-primary">Quản Lý Đơn Hàng Cá Nhân</h2>

    <!-- Filter Section -->
    <div class="card mb-4 shadow-sm border-0 rounded">
        <div class="card-body">
            <h5 class="mb-3">Lọc theo trạng thái:</h5>
            <div class="btn-group d-flex flex-wrap gap-2" role="group">
                <a class="btn btn-outline-primary @(string.IsNullOrEmpty(currentStatus) ? "active" : "")" asp-action="Index">Tất cả</a>
                @foreach (var status in statusDisplay)
                {
                    <a class="btn btn-outline-primary @(currentStatus == status.Key ? "active" : "")" asp-action="Index" asp-route-status="@status.Key">@status.Value</a>
                }
            </div>
        </div>
    </div>

    @if (Model.Any())
    {
        <div class="card shadow-sm border-0 rounded">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="bg-primary text-white">
                            <tr>
                                <th class="ps-4">Mã Đơn Hàng</th>
                                <th>Ngày Tạo</th>
                                <th>Tổng Tiền</th>
                                <th>Trạng Thái</th>
                                <th>Phương Thức Thanh Toán</th>
                                <th class="pe-4">Thao Tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var order in Model)
                            {
                                <tr>
                                    <td class="ps-4">@order.Ma_Hoa_Don</td>
                                    <td>@order.Ngay_Tao.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td>@order.Tong_Tien.ToString("N0") VNĐ</td>
                                    <td>@(statusDisplay.ContainsKey(order.Trang_Thai) ? statusDisplay[order.Trang_Thai] : order.Trang_Thai)</td>
                                    <td>@order.Phuong_Thuc_Thanh_Toan</td>
                                    <td class="pe-4">
                                        <a class="btn btn-primary btn-sm me-2" asp-action="Details" asp-route-id="@order.ID_Hoa_Don">
                                            <i class="fas fa-eye me-1"></i> Chi tiết
                                        </a>
                                        @if (order.Trang_Thai == "Chua_Xac_Nhan")
                                        {
                                            <button class="btn btn-danger btn-sm cancel-order-btn" data-id="@order.ID_Hoa_Don" data-bs-toggle="modal" data-bs-target="#cancelOrderModal">
                                                <i class="fas fa-times me-1"></i> Hủy đơn Hàng 
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="card shadow-sm border-0 rounded">
            <div class="card-body text-center text-muted">
                <p>Bạn chưa có đơn hàng nào trong trạng thái này.</p>
            </div>
        </div>
    }
</div>

<!-- Modal for Cancel Order -->
<div class="modal fade" id="cancelOrderModal" tabindex="-1" aria-labelledby="cancelOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="cancelOrderModalLabel">Hủy Đơn Hàng</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="cancelOrderForm">
                    <input type="hidden" id="orderId" name="idHoaDon" />
                    <input type="hidden" id="idKhachHang" name="idKhachHang" value="@idKhachHang" />
                    <div class="mb-3">
                        <label for="lyDoHuyDon" class="form-label">Lý do hủy đơn hàng</label>
                        <textarea class="form-control" id="lyDoHuyDon" name="lyDoHuyDon" rows="4" placeholder="Vui lòng nhập lý do hủy..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="fas fa-check me-1"></i> Xác nhận hủy
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            $('.cancel-order-btn').click(function () {
                const orderId = $(this).data('id');
                $('#orderId').val(orderId);
            });

            $('#cancelOrderForm').submit(function (e) {
                e.preventDefault();
                const orderId = $('#orderId').val();
                const idKhachHang = $('#idKhachHang').val();
                const lyDoHuyDon = $('#lyDoHuyDon').val();

                // Kiểm tra dữ liệu đầu vào
                if (!lyDoHuyDon) {
                    alert('Vui lòng nhập lý do hủy đơn hàng.');
                    return;
                }

                if (!idKhachHang || isNaN(parseInt(idKhachHang))) {
                    alert('Không thể xác định ID Khách Hàng. Vui lòng đăng nhập lại.');
                    return;
                }

                if (!orderId || isNaN(parseInt(orderId))) {
                    alert('Không thể xác định ID Đơn Hàng. Vui lòng thử lại.');
                    return;
                }

                const data = {
                    iD_Hoa_Don: parseInt(orderId),
                    iD_Khach_Hang: parseInt(idKhachHang),
                    lyDoHuyDon: lyDoHuyDon
                };

                $.ajax({
                    url: 'https://localhost:7169/api/DonHangTK/huy',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function (response) {
                        alert('Hủy đơn hàng thành công!');
                        $('#cancelOrderModal').modal('hide');
                        location.reload();
                    },
                    error: function (xhr) {
                        const errorMessage = xhr.responseJSON?.message || 'Đã có lỗi xảy ra khi hủy đơn hàng.';
                        alert(errorMessage);
                    }
                });
            });
        });
    </script>
}

<style>
    .table th, .table td {
        vertical-align: middle;
    }

    .table thead {
        background: linear-gradient(135deg, #007bff, #00c4ff);
    }

    .table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .btn-outline-primary.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }

    .card {
        transition: transform 0.2s ease;
    }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

    .btn-sm {
        padding: 0.25rem 0.75rem;
        font-size: 0.875rem;
    }

    .modal-content {
        border-radius: 10px;
    }

    .modal-header {
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
    }
</style>